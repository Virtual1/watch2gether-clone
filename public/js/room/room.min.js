const DOMAIN=document.getElementById("DOMAIN").innerText,ROOM_ID=document.getElementById("ROOM_ID").innerText,removeCreditBtn=document.getElementById("credits__close"),ytLinkInp=document.getElementById("search__input"),ytSearchBtn=document.getElementById("search__button"),ytSearchForm=document.getElementById("search__form"),ytSearchVideoLimit=document.getElementById("search__limit");let canAddYTLink=!0;ytSearchBtn.disabled=!0;const roomLinkInp=document.getElementById("link__input"),copyRoomLinkBtn=document.getElementById("link__copy"),copyRoomLinkUserLimit=document.getElementById("link__limit");let canCopyRoomLink=!0;roomLinkInp.value=DOMAIN+"/room/"+ROOM_ID;const usersContainer=document.getElementById("main__users");let userLength=0,myRole="guest",myId="";const chatForm=document.getElementById("chat__form"),chatInp=document.getElementById("chat__input"),chatContainer=document.getElementById("chat__container"),chatSubmitBtn=document.getElementById("chat__button"),chatEmptyMsg=document.getElementById("chat__empty-msg");let canWriteMsg=!0;chatSubmitBtn.disabled=!0;const playlistContainer=document.getElementById("playlist__container"),playlistEmptyMsg=document.getElementById("playlist__empty-message"),playlist=[];let currentPlayingIndex=0;const supported=Plyr.supported("video","youtube",!0);supported.api||(sessionStorage.setItem("browser_not_supported",!0),window.location=DOMAIN);const userFromEurope="Europe"==Intl.DateTimeFormat().resolvedOptions().timeZone.split("/")[0],player=new Plyr("#player",{controls:["play-large","play","progress","current-time","mute","volume","captions","settings","pip","airplay","fullscreen"],tooltips:{controls:!0,seek:!0},keyboard:{focused:!0,global:!0},storage:{enabled:!1},youtube:{noCookie:userFromEurope}});let playerActionByMyself=!0,seekAllowed=!0,rateChangeAllowed=!0;const socket=io();function escapeHTML(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;"};return String(e).replace(/[&<>]/g,e=>t[e]||e)}function uppercaseFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function getVideoIDFromYTURL(e){var t=e.match(/^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);return!(!t||11!=t[2].length)&&t[2]}function checkAddVideoAvailability(){playlist.length<=20?(ytSearchBtn.hidden=!1,ytLinkInp.hidden=!1,ytSearchVideoLimit.style.display="none"):(ytSearchBtn.hidden=!0,ytLinkInp.hidden=!0,ytSearchVideoLimit.style.display="block")}function changeSearchBtnStatus(e,t){ytSearchBtn.innerText=e,ytSearchBtn.classList.replace("btn-primary",`btn-${t}`),ytLinkInp.readOnly=!0,canAddYTLink=!1,setTimeout(()=>{ytSearchBtn.innerText="Add",ytSearchBtn.classList.replace(`btn-${t}`,"btn-primary"),ytLinkInp.readOnly=!1,canAddYTLink=!0},3e3)}function checkRoomLinkAvailability(){userLength<10?(copyRoomLinkUserLimit.style.display="none",roomLinkInp.hidden=!1,copyRoomLinkBtn.hidden=!1):(copyRoomLinkUserLimit.style.display="block",roomLinkInp.hidden=!0,copyRoomLinkBtn.hidden=!0)}function changeCopyRoomLinkStatus(e,t){copyRoomLinkBtn.innerText=e,copyRoomLinkBtn.classList.replace("btn-primary",`btn-${t}`),canCopyRoomLink=!1,setTimeout(()=>{copyRoomLinkBtn.innerText="Copy",copyRoomLinkBtn.classList.replace(`btn-${t}`,"btn-primary"),canCopyRoomLink=!0},3e3)}function copyRoomLink(){if(navigator.clipboard)navigator.clipboard.writeText(roomLinkInp.value).then(()=>{changeCopyRoomLinkStatus("Copied!","success")},e=>{console.log("Failed copying room link: ",e),changeCopyRoomLinkStatus("Error!","danger")});else try{roomLinkInp.focus(),roomLinkInp.select(),document.execCommand("copy"),changeCopyRoomLinkStatus("Copied!","success")}catch(e){console.log("Failed copying room link: ",e),changeCopyRoomLinkStatus("Error!","danger")}}function appendChatMsg(e,t,n,i,o){const a=`\n        <article class="msg-container ${i?"msg-self":"msg-remote"} id="msg-0">\n            <div class="msg-box">\n                ${i?"":`<img class="user-img" src="/assets/room/profile-${e}.png" alt=""/>`}\n                <div class="flr">\n                    <div class="messages">\n                        <p class="msg">\n                            ${escapeHTML(t)}\n                        </p>\n                    </div>\n                    <span class="info">\n                        <span class="username">\n                            ${i?"<u>You</u>":`${uppercaseFirstLetter(o)}-${n}`}\n                        </span>\n                    </span>\n                </div>\n                ${i?`<img class="user-img" src="/assets/room/profile-${e}.png" alt=""/>`:""}\n            </div>\n        </article>\n    `.trim();chatEmptyMsg.hidden||(chatEmptyMsg.hidden=!0),chatContainer.insertAdjacentHTML("beforeend",a),chatContainer.scrollTop=chatContainer.scrollHeight}function punishUser(e,t){"owner"==myRole&&socket.emit(`user-${t}`,e)}function appendUser(e,t,n,i,o){const a=`\n        <figure class="main__user" id=${`user-${n}`}>\n            <img src="/assets/room/profile-${e}.png" alt="" />\n            <figcaption class="text-white">\n                ${i?`<strong>You</strong> (${uppercaseFirstLetter(o)})`:`${uppercaseFirstLetter(o)}-${t}`}\n            </figcaption>\n            ${i||"owner"!=myRole?"":`<i class="bi bi-person-x user__left" title="Ban User" onClick="punishUser('${n}', 'ban')"></i>`}\n            ${"owner"==o?'<i class="bi bi-star-fill user__mid" title="Owner"></i>':""}\n            ${i||"owner"!=myRole?"":`<i class="bi bi-box-arrow-right user__right" title="Kick User" onClick="punishUser('${n}', 'kick')"></i>`}\n        </figure>\n    `.trim();usersContainer.insertAdjacentHTML("beforeend",a)}function removeUser(e){document.getElementById(`user-${e}`).remove()}function checkPlaylistDuplicate(e){let t=!1;return playlist.map(n=>{JSON.stringify(n.id)==JSON.stringify(e)&&(t=!0)}),t}function updateVideoSrc(){const e=playlist[currentPlayingIndex];player.source={type:"video",sources:[{src:e.id,provider:"youtube"}]}}function changePlayingIndex(e){for(let t=0;t<playlist.length;t++)if(playlist[t].id===e&&currentPlayingIndex!=t){socket.emit("playlist-change-playing",t);break}}function addVideoToPlaylist(e,t,n,i,o){playlist.push({id:e,thumbnail:t,title:n,addedBy:i}),0==playlistEmptyMsg.hidden&&(playlistEmptyMsg.hidden=!0),1==playlist.length&&(currentPlayingIndex=0,updateVideoSrc());const a=`\n        <li class="playlist__item" id="playlist_video-${e}">\n            <div class="playlist__item-left">\n                <i class="bi bi-trash" onclick=removeVideoFromPlaylist("${e}") title="Remove from playlist" aria-label="Click here to remove this video from playlist"></i>\n            </div>\n            <div class="playlist__item-right ${1==playlist.length?"playlist__playing":""}" onclick=changePlayingIndex("${e}") title="Click to change playing video" aria-label="Click here to change playing video">\n                <div class="post-thumb">\n                    <img src="${t}" alt="">\n                </div>\n                <div class="post-content">\n                    <h3 class="text-truncate" title="${n}" aria-label="${n}">${n}</h3>\n                    <p class="text-truncate" aria-label="Video Added by">Added by: ${o?"<u>You</u>":`User-${i}`}</p>\n                </div>\n            </div>\n        </li>\n    `.trim();playlistContainer.insertAdjacentHTML("beforeend",a)}function removeVideoFromPlaylist(e){socket.emit("playlist-remove",e)}function removeVideo(e){let t=!1;playlist.map((n,i)=>{JSON.stringify(n.id)===JSON.stringify(e)&&(i==currentPlayingIndex&&(t=!0),playlist.splice(i,1))}),document.getElementById("playlist_video-"+e).remove(),0==playlist.length?(t&&(currentPlayingIndex=-1),playlistEmptyMsg.hidden=!1):playlist.length>0&&(t&&(currentPlayingIndex=0,updateVideoSrc()),playlistContainer.children[1].children[1].classList.add("playlist__playing"))}function changePlayingIndexFunction(e){const t=Number(e);if(!isNaN(t)){if(t>playlist.length-1||playlist.length>0&&t<0)return;playlistContainer.children[currentPlayingIndex+1].children[1].classList.remove("playlist__playing"),playlistContainer.children[t+1].children[1].classList.add("playlist__playing"),currentPlayingIndex=t,updateVideoSrc()}}socket.on("socket_connection_limit",()=>{sessionStorage.setItem("socket_connection_limit",!0),window.location=DOMAIN}),socket.on("socket_user_limit",()=>{sessionStorage.setItem("socket_user_limit",!0),window.location=DOMAIN}),socket.on("socket_connection_ban",()=>{sessionStorage.setItem("socket_connection_ban",!0),window.location=DOMAIN}),socket.on("socket_invalid_input",()=>{sessionStorage.setItem("socket_invalid_input",!0),window.location=DOMAIN}),socket.on("disconnect",()=>{sessionStorage.setItem("socket_disconnect_error",!0),window.location=DOMAIN}),socket.io.on("reconnect_error",()=>{sessionStorage.setItem("socket_reconnect_error",!0),window.location=DOMAIN}),socket.on("user-init",e=>{if(myRole=e.role,myId=e.profileId,userLength++,appendUser(e.profilePic,e.username,e.profileId,!0,e.role),e.otherUsers.length>0&&e.otherUsers.forEach(e=>{appendUser(e.profilePic,e.username,e.profileId,!1,e.role),userLength++}),checkRoomLinkAvailability(),e.playlist.length>0&&e.playlist.forEach(e=>{addVideoToPlaylist(e.ytId,e.thumbnail,e.title,e.addedBy,!1)}),checkAddVideoAvailability(),e.lastVideoPlayed)player.on("ready",()=>{player.source={type:"video",sources:[{src:e.lastVideoPlayed,provider:"youtube"}]},player.currentTime=e.currentVideoTime,player.speed=e.currentVideoSpeed});else if(e.currentPlayingIndex>-1){currentPlayingIndex=e.currentPlayingIndex;const t=playlist[currentPlayingIndex];player.on("ready",()=>{player.source={type:"video",sources:[{src:t.id,provider:"youtube"}]},player.currentTime=e.currentVideoTime,player.speed=e.currentVideoSpeed})}else currentPlayingIndex=-1,player.on("ready",()=>{player.currentTime=e.currentVideoTime,player.speed=e.currentVideoSpeed});e.lastMessages.length>0&&e.lastMessages.forEach(e=>{const{profilePic:t,msg:n,username:i,role:o}=e;appendChatMsg(t,n,i,!1,o)})}),socket.on("user-join",e=>{userLength++,checkRoomLinkAvailability(),appendUser(e.profilePic,e.username,e.profileId,!1,e.role),player.pause()}),socket.on("chat-msg",e=>{appendChatMsg(e.profilePic,e.msg,e.username,!1,e.role)}),socket.on("chat-msg-self",e=>{appendChatMsg(e.profilePic,e.msg,e.username,!0,e.role)}),socket.on("playlist-add",e=>{addVideoToPlaylist(e.ytId,e.thumbnail,e.title,e.addedBy,!1),checkAddVideoAvailability()}),socket.on("playlist-add-success",e=>{addVideoToPlaylist(e.ytId,e.thumbnail,e.title,e.addedBy,!0),checkAddVideoAvailability(),changeSearchBtnStatus("Added!","success")}),socket.on("playlist-add-error",e=>{changeSearchBtnStatus(e,"danger")}),socket.on("playlist-remove",e=>{removeVideo(e),checkAddVideoAvailability()}),socket.on("playlist-change-playing",e=>{changePlayingIndexFunction(e)}),socket.on("video-play",e=>{playerActionByMyself=!1,seekAllowed=!1,player.currentTime=e,player.play()}),socket.on("video-pause",e=>{playerActionByMyself=!1,seekAllowed=!1,player.currentTime=e,player.pause()}),socket.on("video-ratechange",e=>{rateChangeAllowed=!1,player.speed=e}),socket.on("user-kick",()=>{sessionStorage.setItem("socket_user_kick",!0),window.location=DOMAIN}),socket.on("user-ban",()=>{sessionStorage.setItem("socket_user_ban",!0),window.location=DOMAIN}),socket.on("user-role-change",e=>{document.getElementById(`user-${e}`).insertAdjacentHTML("beforeend",'<i class="bi bi-star-fill user__mid" title="Owner"></i>');const t=document.querySelector(`#user-${e} figcaption`);e==myId?(myRole="owner",t.textContent=t.textContent.replace("(Guest)","(Owner)"),document.querySelectorAll(".main__user").forEach(e=>{var t=e.id.split("user-")[1];t!=myId&&(e.insertAdjacentHTML("beforeend",`<i class="bi bi-person-x user__left" title="Ban User" onClick="punishUser('${t}', 'ban')"></i>`),e.insertAdjacentHTML("beforeend",`<i class="bi bi-box-arrow-right user__right" title="Kick User" onClick="punishUser('${t}', 'kick')"></i>`))})):t.textContent=t.textContent.replace("Guest-","Owner-")}),socket.on("user-disconnect",e=>{userLength--,checkRoomLinkAvailability(),removeUser(e)}),removeCreditBtn.addEventListener("click",()=>{setTimeout(()=>{removeCreditBtn.parentElement.hidden=!0},950),removeCreditBtn.parentElement.classList.add("credits__close-animation")}),ytLinkInp.addEventListener("keyup",()=>{ytLinkInp.value.trim().length>0&&canAddYTLink?ytSearchBtn.disabled=!1:ytSearchBtn.disabled=!0}),ytSearchForm.addEventListener("submit",async e=>{e.preventDefault();const t=ytLinkInp.value.trim();if(t.length>0&&canAddYTLink){if(ytLinkInp.value="",ytSearchBtn.disabled=!0,playlist.length>20)return changeSearchBtnStatus("Playlist limit reached","danger");const e=getVideoIDFromYTURL(t);if(!1===e)return changeSearchBtnStatus("Video not found!","danger");if(1==checkPlaylistDuplicate(e))return changeSearchBtnStatus("Video already in playlist!","danger");socket.emit("playlist-add",e)}}),copyRoomLinkBtn.addEventListener("click",()=>{canCopyRoomLink&&copyRoomLink()}),chatInp.addEventListener("keyup",()=>{const e=chatInp.value.trim().replace(/\s{4,}/g," ");e.length>0&&e.length<256?chatSubmitBtn.disabled=!1:chatSubmitBtn.disabled=!0}),chatForm.addEventListener("submit",e=>{if(e.preventDefault(),canWriteMsg){const e=chatInp.value.trim().replace(/\s{4,}/g," ");e.length>0&&e.length<256&&socket.emit("chat-msg",e),chatInp.value="",chatSubmitBtn.disabled=!0}}),player.on("play",()=>{playerActionByMyself?(socket.emit("video-play",player.currentTime),player.currentTime=Number(player.currentTime.toFixed(4)),seekAllowed=!1):playerActionByMyself=!0}),player.on("pause",()=>{playerActionByMyself?(socket.emit("video-pause",player.currentTime),player.currentTime=Number(player.currentTime.toFixed(4)),seekAllowed=!1):playerActionByMyself=!0}),player.on("seeked",()=>{seekAllowed?player.pause():seekAllowed=!0}),player.on("ratechange",()=>{rateChangeAllowed?socket.emit("video-ratechange",player.speed):rateChangeAllowed=!0}),player.on("ended",()=>{if(playlist.length>1){removeVideoFromPlaylist(playlist[currentPlayingIndex].id),checkAddVideoAvailability(),updateVideoSrc()}else if(1==playlist.length){removeVideoFromPlaylist(playlist[currentPlayingIndex].id),checkAddVideoAvailability()}});